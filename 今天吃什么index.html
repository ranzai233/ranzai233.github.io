<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ä»Šå¤©åƒä»€ä¹ˆ Â· DeepSeek AI åŠ©æ‰‹ï¼ˆå®Œæ•´å›ç­”ç‰ˆï¼‰</title>
  <style>
    body {
      font-family: sans-serif;
      background: #fafafa;
      margin: 0;
      padding: 2rem;
      color: #333;
    }

    h1 {
      text-align: center;
    }

    .container {
      max-width: 800px;
      margin: 2rem auto;
      background: white;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      text-align: center;
    }

    button {
      padding: 0.6rem 1.2rem;
      margin: 0.5rem;
      border: none;
      border-radius: 8px;
      background: #007bff;
      color: white;
      cursor: pointer;
      font-size: 1rem;
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .result {
      margin-top: 1.5rem;
      padding: 1.2rem;
      text-align: center;
      font-size: 1.6rem;
      font-weight: bold;
      background: #f5f5f5;
      border-radius: 8px;
      min-height: 3rem;
    }

    .history {
      margin-top: 2rem;
      text-align: left;
    }

    .history-item {
      font-size: 0.9rem;
      color: #555;
      padding: 0.4rem 0;
      border-bottom: 1px solid #eee;
    }

    .ai-section {
      margin-top: 2rem;
      text-align: left;
    }

    .ai-title {
      margin: 0 0 0.6rem 0;
      font-size: 1.1rem;
    }

    .ai-controls {
      display: flex;
      gap: 0.6rem;
      align-items: center;
      margin-bottom: 0.8rem;
    }

    .ai-controls textarea {
      flex: 1;
      min-height: 60px;
      resize: vertical;
      padding: 0.6rem;
      border-radius: 8px;
      border: 1px solid #ddd;
      font-family: inherit;
      font-size: 0.95rem;
    }

    .ai-result {
      background: #f5f5f5;
      border-radius: 8px;
      padding: 0.8rem;
      color: #333;
      font-size: 0.95rem;
      white-space: pre-wrap;
    }

    /* Chat */
    .chat-section {
      margin-top: 2rem;
      text-align: left;
    }

    .chat-title {
      margin: 0 0 0.6rem 0;
      font-size: 1.1rem;
    }

    .chat-window {
      background: #f5f5f5;
      border-radius: 8px;
      padding: 0.8rem;
      height: 260px;
      overflow-y: auto;
    }

    .chat-message {
      padding: 0.5rem 0.6rem;
      border-radius: 6px;
      margin: 0.4rem 0;
      line-height: 1.4;
      white-space: pre-wrap;
    }

    .chat-message.user {
      background: #e6f2ff;
    }

    .chat-message.assistant {
      background: #fff;
    }

    .chat-input {
      display: flex;
      gap: 0.6rem;
      align-items: center;
      margin-top: 0.8rem;
    }

    .chat-input textarea {
      flex: 1;
      min-height: 60px;
      resize: vertical;
      padding: 0.6rem;
      border-radius: 8px;
      border: 1px solid #ddd;
      font-family: inherit;
      font-size: 0.95rem;
    }

    .small {
      font-size: 0.85rem;
      color: #666;
    }
  </style>
</head>

<body>
  <h1>ä»Šå¤©åƒä»€ä¹ˆï¼ŸğŸ¤– DeepSeek AI åŠ©æ‰‹ï¼ˆå®Œæ•´å›ç­”ç‰ˆï¼‰</h1>

  <!-- æ¨¡å‹çŠ¶æ€æŒ‡ç¤ºå™¨ -->
  <div style="text-align: center; margin-bottom: 1rem;">
    <span id="modelStatus" style="padding: 0.5rem 1rem; background: #f0f0f0; border-radius: 6px; font-size: 0.9rem;">
      ğŸ” æ£€æŸ¥æ¨¡å‹çŠ¶æ€...
    </span>
  </div>

  <div class="container">
    <button id="startBtn">å¼€å§‹è½®æ’­</button>
    <button id="stopBtn" disabled>åœæ­¢</button>
    <div class="result" id="result">ç‚¹å‡»â€œå¼€å§‹è½®æ’­â€è¯•è¯•æ‰‹æ°”ï½</div>
    <div class="history">
      <h3>å†å²è®°å½•</h3>
      <div id="historyList"></div>
    </div>

    <div class="ai-section">
      <h3 class="ai-title">ğŸ¤– DeepSeek AI æ¨èï¼ˆä¸ä»…é™äºé£Ÿç‰©ï¼‰</h3>
      <div class="ai-controls">
        <textarea id="aiPreferences" placeholder="å¯å¡«å†™ï¼šå£å‘³åå¥½ã€é¢„ç®—ã€è¾£åº¦ã€å¿Œå£ã€å°±é¤äººæ•°ã€å¿ƒæƒ…ã€æ—¶é—´ç­‰"></textarea>
        <button id="aiBtn">è®© DeepSeek AI æ¨è</button>
      </div>
      <div class="ai-result" id="aiSuggestion">åœ¨ä¸Šæ–¹è¾“å…¥ä½ çš„åå¥½ï¼Œç„¶åç‚¹å‡»â€œè®© AI æ¨èâ€ã€‚</div>
      <div class="small">æç¤ºï¼šAI ä¼šåŒæ—¶ç»™å‡ºâ€œèœå“æ¨è + éé£Ÿç‰©å»ºè®®ï¼ˆæ´»åŠ¨/é¥®å“/éŸ³ä¹/å¿ƒæƒ…å»ºè®®ï¼‰ + æ›¿ä»£æ–¹æ¡ˆâ€ã€‚</div>
    </div>

    <div class="chat-section">
      <h3 class="chat-title">ğŸ¤– DeepSeek AI èŠå¤©</h3>
      <div id="chatWindow" class="chat-window"></div>
      <div class="chat-input">
        <textarea id="chatInput" placeholder="å’Œ DeepSeek AI èŠèŠä»Šå¤©åƒä»€ä¹ˆæˆ–å…¶ä»–æ—¥å¸¸å»ºè®®ï¼ŒEnter å‘é€ï¼ŒShift+Enter æ¢è¡Œ"></textarea>
        <button id="chatSend">å‘é€</button>
      </div>
    </div>
  </div>

  <script>
    document.querySelectorAll('.chat-section').forEach((el, idx) => {
    if (idx > 0) el.remove(); // ä¿ç•™ç¬¬ä¸€ä¸ªï¼Œç§»é™¤å…¶ä½™
  });

  // -----------------------------
  // 2) åˆå§‹åŒ–é˜²æŠ¤ï¼šå¦‚æœè„šæœ¬è¢«é‡å¤æ‰§è¡Œï¼Œåˆ™è·³è¿‡ç¬¬äºŒæ¬¡åˆå§‹åŒ–
  // -----------------------------
  if (window.deepSeekChatInitialized) {
    console.warn('DeepSeek chat already initialized â€” skipping duplicate setup.');
    // ç›´æ¥ return æˆ–åœæ­¢æ‰§è¡Œåç»­é‡å¤ç»‘å®šä»£ç 
  } else {
    window.deepSeekChatInitialized = true;
    const dishes = [
      "çº¢çƒ§ç‰›è‚‰é¢", "å®«ä¿é¸¡ä¸ç›–é¥­", "éº»å©†è±†è…", "ç•ªèŒ„é¸¡è›‹é¢", "é‡åº†å°é¢",
      "ç‰›è‚‰æ±‰å ¡+è–¯æ¡", "å‡¯æ’’æ²™æ‹‰", "ç›æ ¼ä¸½ç‰¹æŠ«è¨", "æ„å¤§åˆ©è‚‰é…±é¢", "å¯¿å¸å¥—é¤",
      "è±šéª¨æ‹‰é¢", "ç‚¸é¸¡+å¯ä¹", "éƒ¨é˜Ÿé”…", "è¶Šå—æ²³ç²‰", "æ³°å¼ç»¿å’–å–±",
      "å’–å–±é¥­(ç´ )", "è’¸é¥º", "ç…é¥º+é…¸è¾£æ±¤", "é¦„é¥¨", "ç¾Šè‚‰æ³¡é¦"
    ];

    const nonFoodSuggestions = [
      "æ•£æ­¥ 20 åˆ†é’Ÿæ”¾æ¾å¿ƒæƒ…",
      "å¬ä¸€å¼ è½»æ¾çš„æ­Œå•ï¼ˆLo-fi/è½»éŸ³ä¹ï¼‰",
      "å–ä¸€æ¯æŸ æª¬æ°´æˆ–çƒ­èŒ¶ï¼Œèˆ’ç¼“èƒƒè‚ ",
      "çœ‹ä¸€éƒ¨çŸ­ç‰‡æˆ–ç»¼è‰ºæ”¾æ¾å¿ƒæƒ…",
      "çº¦æœ‹å‹è§†é¢‘èŠå¤©ï¼Œäº¤æµä¸‹è¿‘å†µ",
      "åš 5 åˆ†é’Ÿä¼¸å±•è¿åŠ¨ï¼Œç¼“è§£ç–²åŠ³",
      "å°è¯•ä¸€ä¸ªç®€å•ç”œç‚¹/é¥®å“çš„è‡ªåˆ¶æ•™ç¨‹",
      "åœ¨é˜³å°æˆ–çª—è¾¹è¯» 10 åˆ†é’Ÿä¹¦/æ–‡ç« "
    ];

    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const result = document.getElementById("result");
    const historyList = document.getElementById("historyList");
    const aiPreferences = document.getElementById("aiPreferences");
    const aiBtn = document.getElementById("aiBtn");
    const aiSuggestion = document.getElementById("aiSuggestion");
    const chatWindow = document.getElementById("chatWindow");
    const chatInput = document.getElementById("chatInput");
    const chatSend = document.getElementById("chatSend");
    const modelStatus = document.getElementById("modelStatus");

    let history = [];
    let spinning = false;
    let timer = null;
    let index = 0;

    // æ£€æŸ¥DeepSeekæ¨¡å‹çŠ¶æ€ï¼ˆä¿æŒåŸæœ‰é€»è¾‘ï¼‰
    async function checkModelStatus() {
      try {
        const resp = await fetch('http://localhost:5000/api/status');
        if (resp.ok) {
          const data = await resp.json();
          if (data.model_loaded) {
            modelStatus.innerHTML = 'âœ… DeepSeek AI æ¨¡å‹å·²å°±ç»ª';
            modelStatus.style.background = '#d4edda';
            modelStatus.style.color = '#155724';
          } else {
            modelStatus.innerHTML = 'âš ï¸ DeepSeek AI æ¨¡å‹æœªåŠ è½½';
            modelStatus.style.background = '#fff3cd';
            modelStatus.style.color = '#856404';
          }
        } else {
          modelStatus.innerHTML = 'âŒ æ— æ³•è¿æ¥åˆ°DeepSeekæœåŠ¡';
          modelStatus.style.background = '#f8d7da';
          modelStatus.style.color = '#721c24';
        }
      } catch (err) {
        modelStatus.innerHTML = 'âŒ è¿æ¥å¤±è´¥ï¼š' + err.message;
        modelStatus.style.background = '#f8d7da';
        modelStatus.style.color = '#721c24';
      }
    }

    checkModelStatus();

    startBtn.addEventListener("click", () => {
      if (spinning) return;
      spinning = true;
      startBtn.disabled = true;
      stopBtn.disabled = false;

      timer = setInterval(() => {
        result.textContent = dishes[index % dishes.length];
        index++;
      }, 80); // æ¯ 80ms åˆ‡æ¢ä¸€æ¬¡
    });

    stopBtn.addEventListener("click", () => {
      if (!spinning) return;
      clearInterval(timer);
      spinning = false;
      startBtn.disabled = false;
      stopBtn.disabled = true;

      const finalChoice = result.textContent;
      history.unshift(finalChoice);
      if (history.length > 10) history = history.slice(0, 10);
      renderHistory();
    });

    function renderHistory() {
      historyList.innerHTML = history.map((h, i) =>
        `<div class="history-item">${i + 1}. ${h}</div>`
      ).join("");
    }

    // æœ¬åœ°å¤‡é€‰ç”Ÿæˆå™¨ï¼ˆå½“æ¨¡å‹ä¸å¯ç”¨æˆ–å“åº”å¤±è´¥æ—¶ï¼Œæä¾›æœ€ç»ˆå›ç­”ï¼‰
    function generateLocalRecommendation(preferences) {
      // ç®€å•ç­–ç•¥ï¼šä¼˜å…ˆä½¿ç”¨å…³é”®è¯åŒ¹é…åå¥½ï¼Œå¦åˆ™éšæœº
      const pref = (preferences || '').toLowerCase();
      let chosen = null;
      for (const d of dishes) {
        if (pref && d.toLowerCase().includes(pref)) {
          chosen = d; break;
        }
      }
      if (!chosen) chosen = dishes[Math.floor(Math.random() * dishes.length)];

      const nonFood = nonFoodSuggestions[Math.floor(Math.random() * nonFoodSuggestions.length)];

      return `æ¨èï¼š${chosen}\nç±»åˆ«ï¼šé£Ÿç‰©\nç†ç”±ï¼šæ ¹æ®ä½ çš„åå¥½ï¼ˆ${preferences || 'æ— '}ï¼‰è¿™æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚\næ›¿ä»£å»ºè®®ï¼š${dishes.filter(x => x !== chosen).slice(0,3).join('ã€')}\n\néé£Ÿç‰©å»ºè®®ï¼š${nonFood}\nå»ºè®®ç†ç”±ï¼šæœ‰åŠ©äºæ”¾æ¾æˆ–é…åˆç”¨é¤æƒ…ç»ªã€‚`;
    }

    // è¾…åŠ©ï¼šå®‰å…¨è§£æ JSON æˆ– æµå¼æ–‡æœ¬å¹¶è¾“å‡º
    async function fetchWithStreamOrJson(url, payload) {
      // å°è¯• POST å¹¶æ ¹æ® content-type å¤„ç† streaming/text/json
      const controller = new AbortController();
      const timeout = setTimeout(() => controller.abort(), 20000); // 20s è¶…æ—¶
      try {
        const resp = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
          signal: controller.signal
        });
        clearTimeout(timeout);
        const ct = resp.headers.get('content-type') || '';
        if (ct.includes('application/json')) {
          const data = await resp.json();
          return { type: 'json', data };
        }

        // å¦‚æœæ˜¯ event-stream æˆ– text/plain/streamingï¼Œåˆ™ç”¨ reader è¯»å–
        if (resp.body && (ct.includes('text/event-stream') || ct.includes('text/plain') || ct.includes('stream'))) {
          const reader = resp.body.getReader();
          const decoder = new TextDecoder('utf-8');
          let done = false;
          let accumulated = '';
          while (!done) {
            const { value, done: d } = await reader.read();
            if (value) {
              accumulated += decoder.decode(value, { stream: true });
              // æŠŠæœ€æ–°çš„å†…å®¹è¿”å›ä»¥ä¾¿å‰ç«¯å¢é‡æ˜¾ç¤º
              return { type: 'stream-chunk', chunk: accumulated, done: d };
            }
            done = d;
          }
          return { type: 'stream-complete', text: accumulated };
        }

        // fallback: try to read as text
        const text = await resp.text();
        try {
          const parsed = JSON.parse(text);
          return { type: 'json', data: parsed };
        } catch (e) {
          return { type: 'text', text };
        }
      } catch (err) {
        clearTimeout(timeout);
        throw err;
      }
    }

    // AI æ¨èæŒ‰é’®ï¼šæ”¯æŒæµ/JSONï¼Œå¹¶åœ¨å¤±è´¥æ—¶ä½¿ç”¨æœ¬åœ°ç”Ÿæˆå™¨ç»™å‡ºæœ€ç»ˆå›ç­”
    aiBtn.addEventListener("click", async () => {
      const preferences = (aiPreferences.value || "").trim();
      aiBtn.disabled = true;
      aiSuggestion.textContent = "DeepSeek AI æ­£åœ¨æ€è€ƒ...";

      // æ„å»ºå¢å¼ºæç¤ºï¼Œè¦æ±‚æ¨¡å‹ç»™å‡ºä¸ä»…é™äºé£Ÿç‰©çš„å›ç­”ï¼Œå¹¶ä»¥ç»“æ„åŒ–æ ¼å¼è¿”å›
      const prompt = `ä½ æ˜¯ä¸€ä¸ªå¤šåŠŸèƒ½æ¨èåŠ©æ‰‹ã€‚ç”¨æˆ·åå¥½ï¼š${preferences || 'æ— '}ã€‚\nå¯é€‰èœå“ï¼š${dishes.join('ã€')}ã€‚\nè¯·ç»™å‡ºï¼š\n- æ¨èï¼ˆç®€çŸ­ï¼‰ï¼šèœå“æˆ–æ–¹æ¡ˆå\n- ç±»åˆ«ï¼šé£Ÿç‰©/é¥®å“/æ´»åŠ¨/å…¶ä»–\n- ç†ç”±ï¼š1-2 å¥\n- è‹¥æ˜¯é£Ÿç‰©ï¼šç»™å‡º1ä¸ªå¿«é€Ÿæ›¿ä»£ï¼ˆå¯é€‰ï¼‰\n- éé£Ÿç‰©å»ºè®®ï¼šè‡³å°‘ä¸€ä¸ªï¼ˆå¦‚æ´»åŠ¨/é¥®å“/éŸ³ä¹/å¿ƒæƒ…/çŸ­å»ºè®®ï¼‰\næ ¼å¼ä¸¥æ ¼ä½¿ç”¨ï¼šæ¨èï¼š...\nç±»åˆ«ï¼š...\nç†ç”±ï¼š...\næ›¿ä»£ï¼š...\néé£Ÿç‰©å»ºè®®ï¼š...\nè¯·æ§åˆ¶æ€»é•¿åº¦åœ¨ 200-400 å­—ä»¥å†…ã€‚`;

      try {
        // å°è¯•è¯·æ±‚åç«¯ï¼ˆæ”¯æŒæµå¼æˆ–ä¸€æ¬¡æ€§ JSONï¼‰
        const resultPayload = await fetchWithStreamOrJson('http://localhost:5000/api/chat', { message: prompt });

        if (resultPayload.type === 'json') {
          const data = resultPayload.data;
          if (data && data.status === 'success' && data.response) {
            aiSuggestion.textContent = data.response;
          } else if (typeof data === 'string' && data.length > 0) {
            aiSuggestion.textContent = data;
          } else {
            // åç«¯è¿”å›ç©ºæˆ–éé¢„æœŸç»“æ„ï¼Œä½¿ç”¨æœ¬åœ°ç”Ÿæˆ
            aiSuggestion.textContent = generateLocalRecommendation(preferences);
          }
        } else if (resultPayload.type === 'stream-chunk' || resultPayload.type === 'stream-complete' || resultPayload.type === 'text') {
          // å°è¯•æ˜¾ç¤ºæµæˆ–æ–‡æœ¬
          aiSuggestion.textContent = resultPayload.chunk || resultPayload.text || resultPayload.text;
        } else {
          aiSuggestion.textContent = generateLocalRecommendation(preferences);
        }
      } catch (err) {
        // å¤„ç†é”™è¯¯ï¼Œå›é€€åˆ°æœ¬åœ°ç”Ÿæˆçš„æœ€ç»ˆå›ç­”
        console.error('AI è¯·æ±‚å¤±è´¥ï¼š', err);
        aiSuggestion.textContent = `ï¼ˆä½¿ç”¨æœ¬åœ°å¤‡é€‰ï¼‰\n${generateLocalRecommendation(preferences)}`;
      } finally {
        aiBtn.disabled = false;
      }
    });

    // ===== AI èŠå¤©ï¼ˆæ”¯æŒæµå¼æˆ–ä¸€æ¬¡æ€§ JSONï¼Œå¤±è´¥å›é€€ï¼‰ =====
    const chatMessages = [];
    function renderChat() {
      chatWindow.innerHTML = chatMessages.map(m => {
        const cls = m.role === 'user' ? 'user' : 'assistant';
        return `<div class="chat-message ${cls}">${(m.content || '').replace(/</g, '&lt;')}</div>`;
      }).join("");
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    async function sendChat() {
      const content = (chatInput.value || "").trim();
      if (!content) return;
      chatInput.value = "";
      chatSend.disabled = true;

      chatMessages.push({ role: 'user', content });
      renderChat();

      // æ·»åŠ "æ­£åœ¨æ€è€ƒ"æ¶ˆæ¯
      const thinkingMsg = { role: 'assistant', content: 'ğŸ¤” DeepSeek AI æ­£åœ¨æ€è€ƒ...' };
      chatMessages.push(thinkingMsg);
      renderChat();

      try {
        const payload = await fetchWithStreamOrJson('http://localhost:5000/api/chat', { message: content });
        if (payload.type === 'json') {
          const data = payload.data;
          if (data && data.status === 'success' && data.response) {
            thinkingMsg.content = data.response;
          } else if (typeof data === 'string' && data.length > 0) {
            thinkingMsg.content = data;
          } else {
            thinkingMsg.content = '(æ— å›å¤)';
          }
        } else if (payload.type === 'stream-chunk' || payload.type === 'stream-complete' || payload.type === 'text') {
          thinkingMsg.content = payload.chunk || payload.text || '(æ— å›å¤)';
        } else {
          thinkingMsg.content = '(æ— å›å¤)';
        }
        renderChat();
      } catch (err) {
        console.error('èŠå¤©è¯·æ±‚å¤±è´¥ï¼š', err);
        thinkingMsg.content = `å‡ºé”™äº†ï¼š${err.message || err} \nï¼ˆä½¿ç”¨æœ¬åœ°å»ºè®®ï¼‰\n${generateLocalRecommendation('')}`;
        renderChat();
      } finally {
        chatSend.disabled = false;
      }
    }

    chatSend.addEventListener('click', sendChat);
    chatInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendChat();
      }
    });
  }
  </script>
</body>

</html>
